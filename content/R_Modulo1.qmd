---
title: "Tutorial R Módulo 1. Importando planilhas do Excel"
subtitle: "Disciplina de Ecologia Numérica^[Curso de Ciências Biológicas do Campus V da UEPB]"
author: 
  - Prof. Elvio S. F. Medeiros  
  - Laboratório de Ecologia
  - Universidade Estadual da Paraíba
  - Campus V, João Pessoa, PB
date: "`r Sys.Date()`"
abstract: "A importação de planilhas do Excel para o ambiente de programação R é uma tarefa fundamental  para análise de dados e estatísticas. Através da importação de planilhas do Excel, é possível transformar dados armazenados em formatos familiares em estruturas que podem ser manipuladas e exploradas de maneira eficaz no R. Isso permite a aplicação de diversas técnicas estatísticas e criação de visualizações informativas, contribuindo para a tomada de decisões embasadas em dados. Neste contexto, entender como importar dados do Excel para o R é um passo crucial para realizar análises de alta qualidade e obter insights significativos a partir dos conjuntos de dados disponíveis."
lang: "pt-br"
editor: source
toc: true
number-sections: true
bibliography: D:/Elvio/OneDrive/Disciplinas/_EcoNumerica/3.R_Markdown/my_references-x9.bib
csl: D:/Elvio/OneDrive/Disciplinas/_EcoNumerica/3.R_Markdown/ecology.csl
highlight-style: pygments
format:
  html:
    code-fold: false
    code-overflow: scroll
    embed-resources: true
  pdf:
    lof: true
    lot: true
    toc: true
    code-line-numbers: true
    colorlinks: true
  docx: default
execute:
  echo: true
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---

# Apresentação

A importação de planilhas do Excel para o ambiente de programação R é uma tarefa fundamental para análise de dados e estatísticas. O R é uma linguagem de programação amplamente utilizada por cientistas de dados, pesquisadores e analistas para manipular, visualizar e modelar informações. Através da importação de planilhas do Excel, é possível transformar dados armazenados em formatos familiares em estruturas que podem ser manipuladas e exploradas de maneira eficaz no R. Isso permite a aplicação de diversas técnicas estatísticas e criação de visualizações informativas, contribuindo para a tomada de decisões embasadas em dados. Neste contexto, entender como importar dados do Excel para o R é um passo crucial para realizar análises de alta qualidade e obter insights significativos a partir dos conjuntos de dados disponíveis.

# Instalação do R e RStudio

## R base

1. O primeiro passo é entrar na página do projeto CRAN (Comprehensive R Archive Network) (https://www.r-project.org/).  
2. Do lado esquerdo da página clique sobre o link CRAN abaixo de Download. 3. Uma nova página com uma série de links irá se abrir. Esses links são chamados de “espelhos” e servem para que você possa escolher o local mais próximo de onde você está para fazer o download do programa. Escolha um espelho no Brasil.  
4. Na seção Download and Install R, clique sobre o link `Download R for Windows` para baixar a versão para esse sistema... (MacOS??... o que é isso?)  
5. Clique sobre o link `base`.
6. Clique sobre o link `Download R 4.x.x for Windows` para fazer o download do arquivo R.exe.
7. A instalação segue o formato padrão de instalação de programas no Windows, e portanto não são necessários maiores detalhes.  

## RStudio

1. Para baixar o RStudio entre no endereço (https://posit.co/download/rstudio-desktop/)  
2. Clique no link `Products > RStudio`  
3. Selecione a versão Desktop.  
4. Clique em `DOWNLOAD RSTUDIO DESKTOP`  
5. Será exibida uma página com a recomendação para você baixar o RStudio FREE versão mais recente - Windows  
6. Clicando nesse link, você irá baixar o arquivo RStudio atual (.exe)
7. Depois é só clicar e instalar da forma convencional do Windows.  

Após a instalação, você pode abrir o `RStudio` pelo seu respectivo ícone, e o RStudio estará pronto para ser utilizado. O "R base" continuará instalado mas será acessado pelo RStudio. Não o desinstale.

# RStudio na nuvem

Usar o RStudio Cloud (https://login.rstudio.cloud/) é uma opção para quem não quer instalar a versão para PC. O RStudio Cloud é uma plataforma online que fornece um ambiente de desenvolvimento integrado para o R, permitindo que os usuários executem análises, desenvolvam código e colaborem com outras pessoas, sem a necessidade de instalar o R e o RStudio em seus próprios computadores. É uma solução conveniente e acessível, especialmente para iniciantes ou usuários que desejam compartilhar projetos e colaborar de forma eficiente.

## Sobre os dados do PPBio

Usaremos para esse tutorial dados coletados no Programa de Pesquisa em Biodiversidade - PPBio (veja [Programa de Pesquisa em Biodiversidade -- PPBio](https://ppbio.inpa.gov.br/Sobre)). Nesta base de dados estão armazenadas informações sobre diversos grupos taxonômicos dstribuidos em diversas unidades amostrais (UA's ou sítios), como peixes, macroinverbrebrados bentônicos, quironomídeos e zooplâncotn, além de dados do habitat, como variáveis físicas e químicas, morfologia do habitat, composição do substrato, estrutura de habitat marginal, entre outros (@fig-ppbio)). Essa é a **matriz bruta de dados**, porque os valores ainda não foram ajustados para os valores de Captura Por Unidade de Esforço (CPUE), nem foram relativizados ou transformados (@tbl-301arqs).

![Parte da planilha de dados brutos do PPBio.](D:/Elvio/OneDrive/Disciplinas/_EcoNumerica/3.R_Quarto/imagens/ppbio.png){#fig-ppbio}

```{r}
#| label: tbl-301arqs
#| tbl-cap: Matrizes disponíveis para análises, com suas descrições e tipos de dados recomendados. 
#| echo: false
#| purl: false
arqs <- tibble::tribble(
~"Arquivo (.xlsx)", ~"Tipo de matriz", ~"Descrição", ~"Tipo de dados",
"ppbio06c", "Matriz comunitária", "O arquivo ppbio06 traz os dados brutos que serão usados nas análises. A matriz de dados brutos contendo 26 localidades em estações do ano diferentes (objetos) x 35 espécies (atributos), antes de qualquer modificação.", "Contagens de indivíduos com alta amplitude de variação, sugerido uso de matriz relativizada.",
"ppbio06h", "Matriz ambiental", "O arquivo ppbio06h traz os dados brutos que serão usados nas análises. A matriz de dados brutos contendo 26 localidades em estações diferentes (objetos) x 35 variáveis ambienteis (atributos) medidas em diferentes escalas espaciais, antes de qualquer modificação.", "Unidades de medição diferentes (cm, m, °C, mg/L, etc.), com uma alta amplitude de variação, sugerido uso de matriz transformada e/ou reescalada.",
"ppbio06", "Matriz comunitária", "O arquivo ppbio06 traz os dados brutos que serão usados nessa análise. A matriz de dados brutos contendo 26 locais/ocasiões (objetos) x 35 espécies (atributos), antes de qualquer modificação.", "Contagens de indivíduos com alta amplitude de variação, sugerido uso de matriz relativizada.",
"ppbio06cpue", "Matriz comunitária", "O arquivo ppbio06cpue traz os valores depois de terem sidos ajustados pela Captura Por Unidade de Esforço (CPUE), onde o número de indivíduos de cada espécie em uma determinada UA é dividido pelo esforço de captura daquela UA. Isso significa que os dados foram relativizados pela CPUE. A matriz de dados brutos contendo 26 localidades em estações do ano diferentes (objetos) x 35 espécies (atributos), antes de qualquer modificação.", "Densidades de indivíduos (no. de indivíduos por Unidade de Esforço de Captura) com alta amplitude de variação, sugerido uso de matriz relativizada."
)
library(knitr)
library(kableExtra)
arqsx <- kable(arqs, row.names = FALSE, align="l", booktabs = TRUE)
arqsx <- kable_styling(arqsx)
column_spec(arqsx, 1:4, width = c("2cm","2cm","7cm","5cm"))
```

A planilha `ppbio` contém o delineamento amostral de um dos estudos do Projeto PPBio (Figura @fig-fig3). Nas linhas são apresentadas as abreviações dos nomes das unidades amostrais (UA's) e nas colunas são apresentados os nomes abreviados das espécies - temos portando uma matriz comunitária (@tbl-301arqs)). No corpo da planilha temos os valores para o tipo de dados amostrado. Quantitativo, semi-quatitativo ou qualitativo.  
Qual desses tipos de dados você acha que é apresentado na planilha?

![Associação entre a planilha de dados brutos do PPBio e o delineamento amostral do estudo.](D:/Elvio/OneDrive/Disciplinas/_EcoNumerica/3.R_Quarto/imagens/rm1.fig3.png){#fig-fig3}

Várias das espécies nessa matriz tem grande importância ecológica, como é o caso de *Astyanax bimaculatus* [^1] (@fig-asbim)), que é muito comum em rios intermitentes e serve de alimento para predadores maiores como a espécie *Hoplias malabaricus* [^2] (@fig-hmala)).

[^1]: A etimologia do gênero *Astyanax* vem da mitologia Grega. Heitor personagem da "Ilíada", tinha um filho chamado Astíanax.

[^2]: Do Grego, *hoplon*, arma ou armadura, em referência aos dentes caniniformes muito desenvolvidos, e forte estrutura óssea na cabeça. 

![*Astyanax bimaculatus*, a espécie mais comum da matriz de dados ppbio. Peru, by Eakins, R. Fonte: <https://www.fishbase.se/summary/Astianax-bimaculatus.html>](D:/Elvio/OneDrive/Disciplinas/_EcoNumerica/3.R_Quarto/imagens/spp/Asbim_u4.jpg){#fig-asbim}

![*Hoplias malabaricus*, espécie que cresce para se tornar um importante predador. Brazil, by Roselet, F.F.G. Fonte: <https://www.fishbase.se/summary/Hoplias-malabaricus.html>](D:/Elvio/OneDrive/Disciplinas/_EcoNumerica/3.R_Quarto/imagens/spp/Homal_u6.jpg){#fig-hmala}

# Importando a planilha de trabalho

Para começar a usar o R e analisar os dados do Projeto PPBio, abra o RStudio, verifique sua interface (@fig-interface)) e siga as instruções a seguir.

![Interface típica do RStudio e nome dos paineis  ou janelas.](D:/Elvio/OneDrive/Disciplinas/_EcoNumerica/3.R_Quarto/imagens/interfaceR.png){#fig-interface}


::: callout-caution
# Mensagens de erro e avisos no R

No contexto da linguagem de programação R, mensagens de erro (errors) e mensagens de aviso (warnings) que [aparecem em vermelho no painel de console]{style="color:red"}. Elas são formas de feedback do sistema que indicam problemas ou situações potencialmente problemáticas durante a execução do código. Aqui está uma breve explicação de cada um:

1.  **Erro ([Error]{style="red"}):**
    -   Um erro ocorre quando algo no código não está correto ou não pode ser executado como esperado.
    -   Isso pode ser causado por sintaxe incorreta, uso incorreto de funções, operações inválidas, referências a objetos que não existem, entre outros problemas.
    -   Quando ocorre um erro, a execução do código é interrompida e uma mensagem de erro é exibida no console em vermelho, indicando o tipo de erro e, muitas vezes, a linha onde ocorreu.
2.  **Aviso ([Warning]{style="red"}):**
    -   Não indica erro. Um aviso é emitido quando algo no código pode resultar em um comportamento indesejado ou em resultados inesperados, mas não interrompe necessariamente a execução do código.
    -   Os avisos geralmente indicam situações que merecem atenção, como conversões de tipos de dados que podem perder informações ou funções que estão sendo usadas de maneira que pode levar a resultados questionáveis.
    -   Os avisos são exibidos em vermelho no console e fornecem informações sobre a natureza do aviso e, possivelmente, como abordá-lo.

É importante prestar atenção a mensagens de erro e avisos, pois eles fornecem insights sobre problemas em seu código ou potenciais fontes de comportamento inesperado. Resolver erros é fundamental para que o código funcione conforme o esperado. Embora os avisos não interrompam a execução, investigá-los pode ajudar a evitar problemas futuros ou melhorar a qualidade do código.
:::









## Organização básica

No ambiente do RStudio no painel de edição de código execute (`Ctrl+Enter` com o  teclado  ou `Run` no editor de código) os comandos a seguir, para instalar os pacotes necessários para este módulo.

```{r}
#| eval: false
#| code-overflow: wrap
install.packages("readxl") #importa arquivos do excel
```

E em seguida,

```{r}
library(readxl)
```

Os códigos acima, são usados para instalar e carregar os pacotes necessários para este módulo. Esses códigos são comandos para instalar pacotes no R. Um pacote é uma coleção de funções, dados e documentação que ampliam as capacidades do R ([R CRAN](https://cran.r-project.org/)) [@RN2774], e
[RStudio](https://posit.co/download/rstudio-desktop/) [@RN358]. No exemplo acima, o pacote `readxl` permite ler e escrever arquivos Excel no R.

Para instalar um pacote no R, você precisa usar a função `install.packages()`. Depois de instalar um pacote, você precisa carregá-lo na sua sessão R com a função `library()`.

Por exemplo, para carregar o pacote `readxl`, você precisa executar a função `library(readxl)`. Isso irá permitir que você use as funções do pacote na sua sessão R. Você precisa carregar um pacote toda vez que iniciar uma nova sessão R e quiser usar um pacote instalado.

Agora vamos **definir o diretório de trabalho**. Esse código é usado para obter e definir o diretório de trabalho atual no R. O comando `getwd()` retorna o caminho do diretório onde o R está lendo e salvando arquivos. O comando `setwd()` muda esse diretório de trabalho para o caminho especificado entre aspas. No seu caso, você deve ajustar o caminho para o seu próprio diretório de trabalho. **Lembre de usar a barra "/" entre os diretórios. E não a contra-barra "\\".**

Usaremos uma matriz multivariada (sítios x espécies, matriz comunitária) do Projeto PPBio chamada ppbio**.xlsx que está no diretório ["C:/Meu/Diretório/De/Trabalho/Planilha.xlsx"]{style="color:blue"}

Note que o sómbolo `#` em programação R significa que o texto que vem depois dele é um comentário e não será executado pelo programa. Isso é útil para explicar o código ou deixar anotações.

Ajuste a segunda linha do código abaixo para refletir ["C:/Seu/Diretório/De/Trabalho/Planilha.xlsx"]{style="color:red"}.

Definindo o diretório de trabalho e installando os pacotes necessários:

```{r}
#| eval: false
getwd()
setwd("C:/Seu/Diretório/De/Trabalho")
```

Alternativamente você pode ir na barra de tarefas e escolhes as opções:\\SESSION -\> SET WORKING DIRECTORY -\> CHOOSE DIRECTORY

### Prefira sempre códigos e scripts do que mouse e menus de janelas no R

::: callout-caution
# Porque preferir códigos e scripts do que mouse e menus de janelas no R

Optar pelo uso de scripts e comandos de teclado no R, em vez das opções baseadas em mouse e menus das janelas, oferece várias vantagens significativas para quem está envolvido em análises de dados e programação. Aqui estão algumas justificativas para essa abordagem:

1. **Reprodutibilidade:** O uso de scripts permite que todas as etapas de análise e manipulação de dados sejam documentadas em um único lugar. Isso facilita a reexecução de todo o processo, tornando a análise reprodutível e permitindo que outras pessoas compreendam e validem o trabalho realizado.

2. **Automação:** Comandos de script podem ser facilmente repetidos ou adaptados para diferentes conjuntos de dados. Isso possibilita a automação de tarefas complexas, economizando tempo e reduzindo a possibilidade de erros manuais.

3. **Flexibilidade:** Enquanto as opções de mouse e menus podem ser limitadas em termos das ações específicas que permitem, os scripts oferecem uma flexibilidade muito maior. Você pode personalizar cada etapa do processo de análise de acordo com suas necessidades específicas.

4. **Eficiência:** A digitação de comandos é geralmente mais rápida do que navegar por menus e clicar em botões, especialmente quando se trata de tarefas repetitivas e/ou complexas.

5. **Controle total:** Ao utilizar scripts, você tem controle total sobre cada etapa do processo. Isso é particularmente importante em análises estatísticas, onde pequenas variações nos parâmetros podem ter um grande impacto nos resultados.

6. **Aprendizado contínuo:** Escrever e modificar scripts permite um maior aprendizado e domínio da linguagem R. Conforme você ganha experiência, poderá realizar análises mais sofisticadas e explorar recursos avançados.

7. **Portabilidade:** Scripts podem ser facilmente compartilhados com outros pesquisadores ou colegas, independentemente do sistema operacional utilizado. Isso torna a colaboração mais fluida e ajuda a evitar problemas de compatibilidade.

8. **Melhor entendimento:** Ao escrever e ler scripts, você desenvolve uma compreensão mais profunda dos processos que está realizando. Isso é importante para identificar possíveis erros e interpretar corretamente os resultados.

9. **Documentação clara:** Ao escrever um script, você pode adicionar comentários explicativos que descrevem cada passo e sua lógica. Isso resulta em uma documentação clara e autoexplicativa do trabalho realizado.

10. **Consistência:** O uso de scripts promove a adoção de práticas consistentes em toda a análise, reduzindo a chance de erros causados por abordagens diferentes em momentos distintos.

Em resumo, a abordagem baseada em scripts e comandos de teclado oferece mais controle, flexibilidade, eficiência e reprodutibilidade, tornando-a a escolha preferida para profissionais que buscam análises de dados precisas, consistentes e de alta qualidade no ambiente R.
:::

# Importando a planilha

```{r}
#| results: false
#| code-overflow: wrap
library(readxl)
ppbio06 <- read_excel("D:/Elvio/OneDrive/Disciplinas/_EcoNumerica/5.Matrizes/ppbio06.xlsx", sheet = "Sheet1", na = "NA")
str(ppbio06)
class(ppbio06)
```

Com essas linhas de código a primeira coluna  da matriz importada apresenta texto. Não queremos assim porque vamos fazer cálculos matemáticos na matriz.

Resolvemos o problema com esse novo pacote de importação de arquivos .xlsx para o R.

```{r}
#| results: false
#| code-overflow: wrap
#install.packages("openxlsx")
library(openxlsx)
ppbio <- read.xlsx("D:/Elvio/OneDrive/Disciplinas/_EcoNumerica/5.Matrizes/ppbio06.xlsx",
                   rowNames = T,
                   colNames = T,
                   sheet = "Sheet1")
str(ppbio)
class(ppbio)
ppbio_ma <- as.matrix(ppbio) #lê ppbio como uma matriz
str(ppbio_ma)
class(ppbio_ma)
#ppbio
#ppbio_ma
```

Agora podemos exportar os dados como uma matriz de dados em formato de `valores separados por vírgula (.csv)`.

```{r}
#| eval: false
#| results: false
#| code-overflow: wrap
write.table(ppbio, "ppbiocsv.txt", append = F, quote = T, ";", row.names = T)
dir <- getwd()
shell.exec(dir) #abre o diretorio de trabalho no Windows Explorer
```

Podemos abrir o arquivo .csv criado `ppbiocsv.txt` usando os códigos abaixo.

```{r}
#| eval: false
#| results: false
#| code-overflow: wrap
ppbiocsv <- read.csv("ppbiocsv.txt",
                     sep = ";", dec = ",", #definimos o dígito separador
                     header = T,
                     row.names = 1,
                     na.strings = NA)

str(ppbiocsv)
ppbiocsv
```

Lembre de prestar atenção no dígito separador de decimais " , " ou " . " . Além disso, só estaamos usando  `ppbio**.***` porque o diretório de trabalho ja fo definido no início. Se não deveríamos estar usando `C:/Seu/Diretório/De/Trabalho/ppbio**.***`

Alguns comando para exibir a planilha são "case-sensitive" (ignore.case(object))

```{r}
#| eval: false
#| results: false
#| code-overflow: wrap
View(ppbio)
print(ppbio)
ppbio
str(ppbio)
?View
?view
?remove
```


### Outra forma de achar e importar uma planilha

Essa forma é desaconselhavel por é demorada e sujeita a erros. Além  de precisar ser refeita sempre que se quiser abrir uma nova planilha ou reabrir a última planilha importada. Veja o tópico [Prefira sempre códigos e scripts do que mouse e menus de janelas no R]


```{r}
#| eval: false
getwd()
ppbio <- read.xlsx(file.choose(),  #abre o windows explorer
                   rowNames = T, colNames = T,
                   sheet = "Sheet1")
```

# Referências

::: {#refs}
:::

# Apêndices {.unnumbered}

## Sites consultados {.unnumbered}
[https://youtu.be/U6ksXvvY6Q0]  
[https://youtu.be/a7EJE_2mtGk]

 
